name: Build and deploy Docker app  # 工作流名称

env:
  DOCKER_IMAGE_NAME: dailymanagement-image  # 镜像名称全部小写
  DOCKER_REGISTRY: tonydmacr.azurecr.io  # 替换为你的 Azure 容器注册表地址
  SERVER_HOST: 20.24.210.200  # 替换为你的服务器 SSH 主机地址
  SERVER_USER: TonyAdmin  # 替换为你的服务器 SSH 用户名
  SERVER_BASE_PATH: /home/TonyAdmin  # 服务器基础路径

on:
  push:
    branches: [ "main" ]  # 当推送到 main 分支时触发工作流
  workflow_dispatch:  # 允许手动触发工作流

permissions:
  contents: read  # 设置工作流权限，仅允许读取内容

jobs:
  build:
    runs-on: ubuntu-latest  # 使用最新的 Ubuntu 运行器

    steps:
      - name: Check out code  # 检出代码
        uses: actions/checkout@v4

      - name: Log in to Azure Container Registry  # 登录到 Azure 容器注册表
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.DOCKER_REGISTRY }}  # 使用 Azure 容器注册表地址
          username: ${{ secrets.AZURE_ACR_USERNAME }}  # 从 GitHub Secrets 中获取 ACR 用户名
          password: ${{ secrets.AZURE_ACR_PASSWORD }}  # 从 GitHub Secrets 中获取 ACR 密码

      - name: Build Docker image  # 构建 Docker 镜像
        run: |
          docker build -t ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:latest .

      - name: Push Docker image to registry  # 推送 Docker 镜像到注册表
        run: |
          docker push ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:latest

  deploy:
    runs-on: ubuntu-latest  # 使用最新的 Ubuntu 运行器
    needs: build  # 此作业依赖于 build 作业

    steps:
      - name: Check out code  # 检出代码（用于上传文件）
        uses: actions/checkout@v4

      - name: List files for debug  # 调试：列出根目录和 frontend 目录下的文件
        run: |
          echo "根目录文件列表："
          ls -al
          echo "frontend 目录文件列表："
          ls -al frontend || true

      - name: Upload files to server via scp  # 自动上传配置和静态文件（优化，只上传必要前端资源）
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: |
            docker-compose.yml
            nginx.conf
            frontend/*.html
            frontend/css/
            frontend/js/
            frontend/libs/
          target: ${{ env.SERVER_BASE_PATH }}/deploy-temp

      - name: Deploy and restart services on server  # 远程部署和重启服务
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # 移动上传的文件到对应目录
            mv ${{ env.SERVER_BASE_PATH }}/deploy-temp/docker-compose.yml ${{ env.SERVER_BASE_PATH }}/docker-compose/docker-compose.yml
            mv ${{ env.SERVER_BASE_PATH }}/deploy-temp/nginx.conf ${{ env.SERVER_BASE_PATH }}/nginx/nginx.conf
            cp -r ${{ env.SERVER_BASE_PATH }}/deploy-temp/frontend/* ${{ env.SERVER_BASE_PATH }}/frontend/
            # 拉取最新镜像
            docker pull ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:latest
            # 进入 compose 目录并重启服务
            cd ${{ env.SERVER_BASE_PATH }}/docker-compose
            docker-compose down
            docker-compose up -d
            # 配置 Nginx 作为反向代理
            docker pull nginx:latest
            docker rm -f nginx-proxy || true
            docker run -d --name nginx-proxy \
              -p 80:80 \
              -v ${{ env.SERVER_BASE_PATH }}/nginx/nginx.conf:/etc/nginx/nginx.conf:ro \
              -v ${{ env.SERVER_BASE_PATH }}/frontend:/usr/share/nginx/html:ro \
              --network host nginx
            # 清理临时目录
            rm -rf ${{ env.SERVER_BASE_PATH }}/deploy-temp
