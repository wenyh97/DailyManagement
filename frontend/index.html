<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日常管理系统 - 34金币法则</title>
    <link rel="stylesheet" href="libs/flatpickr.min.css">
    <link rel="stylesheet" href="libs/fullcalendar.min.css">
    <link rel="stylesheet" href="libs/choices.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="libs/particles.min.js"></script>
    <script src="libs/lunar.min.js"></script>
    <script src="libs/fullcalendar.min.js"></script>
    <script src="libs/flatpickr.min.js"></script>
    <script src="libs/flatpickr.zh.js"></script>
    <script src="libs/choices.min.js"></script>
    <script src="js/auth.js"></script>
    <script>
        checkLogin();
    </script>
</head>
<body>
    <!-- 动态粒子背景 -->
    <div id="particles-js"></div>
    
    <div id="app">
        <header class="tech-header">
            <div class="header-bg"></div>
            <div class="header-container">
                <!-- 左侧：系统名称和标语 -->
                <div class="header-left">
                    <h1><span class="icon">⚡</span> 日常管理系统</h1>
                    <p class="subtitle">34金币时间管理法则 · 让每一天都充满价值</p>
                </div>
                
                <!-- 中间：导航菜单 -->
                <nav class="header-nav">
                    <button class="nav-btn" data-page="ideas">
                        <span class="nav-icon">💡</span>
                        <span>任务管理</span>
                    </button>
                    <button class="nav-btn active" data-page="daily">
                        <span class="nav-icon">📅</span>
                        <span>日常管理</span>
                    </button>
                    <button class="nav-btn" data-page="stats">
                        <span class="nav-icon">📊</span>
                        <span>数据统计</span>
                    </button>
                    <button class="nav-btn" data-page="manage" id="nav-manage">
                        <span class="nav-icon">🛠️</span>
                        <span>管理</span>
                    </button>
                </nav>
                
                <!-- 右侧：用户信息与服务健康 -->
                <div class="header-right" style="display: flex; align-items: center; gap: 15px;">
                    <div class="user-info" style="color: white; display: flex; align-items: center; gap: 10px;">
                        <span id="user-display-name"></span>
                        <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">退出</button>
                    </div>
                    <div class="service-health">
                        <span class="health-icon">🩺</span>
                        <span id="api-status-indicator" class="health-status">检测中</span>
                    </div>
                </div>
            </div>
        </header>
        
        <main>
            <!-- 任务管理页面（含年度规划） -->
            <div id="page-ideas" class="page-content">
                <div class="planning-workspace" id="planning-workspace">
                    <div class="planning-tab-buttons" role="tablist" aria-label="规划工作区子页签">
                        <button class="planning-tab-btn active" data-planning-tab="annual" role="tab" aria-selected="true">年度规划</button>
                        <button class="planning-tab-btn" data-planning-tab="execution" role="tab" aria-selected="false">目标执行</button>
                        <button class="planning-tab-btn" data-planning-tab="tasks" role="tab" aria-selected="false">任务管理</button>
                    </div>

                    <section id="planning-panel-annual" class="planning-tab-panel active" data-panel="annual" role="tabpanel">
                        <div class="glass-card planning-card">
                            <div class="section-header planning-header">
                                <h2><span class="icon">🎯</span> 年度规划</h2>
                                <div class="planning-actions">
                                    <button type="button" class="btn-primary planning-add-btn" id="open-plan-modal">+ 添加规划</button>
                                </div>
                            </div>
                            <div id="planning-loading" class="planning-loading">
                                <span class="loading-dot"></span>
                                <span>正在加载年度规划...</span>
                            </div>
                            <div id="plan-accordion" class="plan-accordion"></div>
                        </div>
                    </section>

                    <section id="planning-panel-execution" class="planning-tab-panel" data-panel="execution" role="tabpanel">
                        <div class="glass-card planning-card">
                            <div class="section-header planning-header">
                                <h2><span class="icon">🚀</span> 目标执行</h2>
                            </div>
                            <div id="goal-execution-list" class="goal-execution-board">
                                <div class="goal-empty">点击年度规划中的“执行”按钮，即可在此构建目标执行看板。</div>
                            </div>
                        </div>
                    </section>

                    <section id="planning-panel-tasks" class="planning-tab-panel" data-panel="tasks" role="tabpanel">
                        <div class="glass-card">
                            <div class="section-header">
                                <h2><span class="icon">💡</span> 灵感收集站</h2>
                                <select id="idea-sort" class="idea-sort-select">
                                    <option value="time">按时间排序</option>
                                    <option value="priority">按优先级排序</option>
                                </select>
                            </div>
                            <div id="ideas-list" class="ideas-container"></div>
                            <div class="input-group">
                                <input type="text" id="new-idea" placeholder="💭 记录你的灵感和想法...">
                                <button id="add-idea" class="btn-primary">+ 添加</button>
                            </div>
                        </div>
                    </section>
                </div>
                <div id="plan-modal" class="modal hidden" aria-hidden="true">
                    <div class="modal-content plan-modal-content" role="dialog" aria-modal="true" aria-labelledby="plan-modal-title">
                        <div class="modal-header">
                            <div class="modal-title">
                                <span class="modal-icon">📝</span>
                                <div class="modal-heading">
                                    <h2 id="plan-modal-title">添加年度规划</h2>
                                    <p id="plan-modal-description">合理拆解年度方向，使用 100 积分规划最重要的事情。</p>
                                </div>
                            </div>
                            <button type="button" class="close-button" id="plan-modal-close" aria-label="关闭">&times;</button>
                        </div>
                        <form id="plan-form">
                            <div class="modal-body plan-modal-body">
                                <label class="modal-label" for="plan-title">规划名称</label>
                                <input type="text" id="plan-title" placeholder="例如：2026 成长驱动计划" required>

                                <label class="modal-label" for="plan-description">规划描述</label>
                                <textarea id="plan-description" rows="3" placeholder="补充规划背景或衡量指标（可选）"></textarea>

                                <label class="modal-label" for="plan-year">规划年份</label>
                                <select id="plan-year" class="plan-year-select" aria-label="规划年份">
                                    <option value="">请选择年份</option>
                                </select>

                                <div class="plan-score-summary">
                                    <div class="modal-field">
                                        <label class="modal-label">规划总分</label>
                                        <div id="plan-total-value" class="plan-total-value">0 分</div>
                                    </div>
                                    <div class="modal-field plan-remaining-hint">
                                        <label class="modal-label">剩余可用</label>
                                        <span id="plan-modal-remaining" class="plan-modal-remaining">剩余 100 分</span>
                                    </div>
                                </div>

                                <div class="plan-goal-section">
                                    <div class="plan-goals-header">
                                        <div>
                                            <h3>目标列表</h3>
                                            <p>至少添加一个目标，后续可在执行面板中跟踪状态。</p>
                                        </div>
                                        <button type="button" class="btn-secondary goal-add-btn" id="add-goal-row">+ 添加目标</button>
                                    </div>
                                    <div id="plan-goals-container" class="plan-goals-container"></div>
                                    <p class="goal-hint">提示：为每个目标分配合理分值，可按季度/主题拆解并填入预计时间。</p>
                                </div>

                                <div id="plan-modal-error" class="plan-modal-error" role="alert"></div>
                            </div>
                            <div class="modal-actions plan-modal-actions">
                                <button type="button" class="btn-secondary" id="plan-modal-cancel">取消</button>
                                <button type="submit" class="btn-primary" id="plan-submit-button">保存规划</button>
                            </div>
                        </form>
                    </div>
                </div>
                <template id="plan-goal-row-template">
                    <div class="goal-row" data-goal-row>
                        <div class="goal-row-grid">
                            <div class="modal-field">
                                <label class="modal-label">目标名称</label>
                                <input type="text" class="goal-name" placeholder="例如：完成 OKR KR1">
                            </div>
                            <div class="modal-field">
                                <label class="modal-label">预计时间</label>
                                <input type="text" class="goal-timeframe" placeholder="Q1 / 3 月 / 暑期">
                            </div>
                            <div class="modal-field goal-score-field">
                                <label class="modal-label">目标分值</label>
                                <input type="number" class="goal-score" placeholder="例如 10" min="1" max="100">
                            </div>
                        </div>
                        <div class="modal-field">
                            <label class="modal-label">目标详情</label>
                            <textarea class="goal-details" rows="2" placeholder="补充说明（可选）"></textarea>
                        </div>
                        <button type="button" class="goal-remove-btn" data-remove-goal>删除目标</button>
                    </div>
                </template>
            </div>
            
            <!-- 日常管理页面 -->
            <div id="page-daily" class="page-content active">
                <div class="glass-card">
                    <div class="section-header">
                        <h2><span class="icon">📅</span> 日程管理</h2>
                        <div id="calendar-legend" class="calendar-legend"></div>
                        <div class="section-actions">
                            <div class="urgency-filter-group">
                                <label class="filter-label" for="urgency-filter">紧急程度</label>
                                <select id="urgency-filter" class="urgency-filter-select">
                                    <option value="">全部紧急程度</option>
                                    <option value="紧急且重要">紧急且重要</option>
                                    <option value="不紧急且重要">不紧急且重要</option>
                                    <option value="紧急且不重要">紧急且不重要</option>
                                    <option value="不紧急且不重要">不紧急且不重要</option>
                                </select>
                                <button type="button" id="urgency-filter-clear" class="btn-tertiary">清空筛选</button>
                            </div>
                            <button id="add-event-button" class="btn-add-event">+ 新建事件</button>
                        </div>
                    </div>
                    <div id="calendar-view"></div>
                    <div id="calendar-score-bar" class="score-bar hidden"></div>
                </div>
            </div>
            
            <!-- 数据统计页面 -->
            <div id="page-stats" class="page-content">
                <div class="glass-card">
                    <div class="section-header">
                        <h2><span class="icon">📊</span> 数据统计</h2>
                        <div class="stats-filters">
                            <select id="stats-year" class="stats-select">
                                <option value="">全部年份</option>
                            </select>
                            <select id="stats-month" class="stats-select">
                                <option value="">全年</option>
                                <option value="1">1月</option>
                                <option value="2">2月</option>
                                <option value="3">3月</option>
                                <option value="4">4月</option>
                                <option value="5">5月</option>
                                <option value="6">6月</option>
                                <option value="7">7月</option>
                                <option value="8">8月</option>
                                <option value="9">9月</option>
                                <option value="10">10月</option>
                                <option value="11">11月</option>
                                <option value="12">12月</option>
                            </select>
                            <span class="badge" id="stats-update-time">加载中...</span>
                        </div>
                    </div>
                    <div id="stats-container" class="stats-container">
                        <div class="stats-loading">正在加载统计数据...</div>
                    </div>
                </div>
            </div>

            <!-- 管理中心页面 -->
            <div id="page-manage" class="page-content">
                <div class="glass-card">
                    <div class="section-header">
                        <h2><span class="icon">🛠️</span> 管理中心</h2>
                        <span class="badge">事件类型</span>
                    </div>
                    <div class="manage-grid">
                        <section class="manage-section" id="admin-section" style="display:none;">
                            <h3>用户管理</h3>
                            <p class="manage-hint">管理系统用户和权限。</p>
                            <a href="admin.html" class="btn-primary manage-submit" style="text-decoration:none; display:inline-block; text-align:center;">进入用户管理</a>
                        </section>
                        <section class="manage-section">
                            <h3>已创建类型</h3>
                            <p class="manage-hint">在这里查看或删除事件类型，保持分类清晰。</p>
                            <div id="manage-type-list" class="manage-type-list"></div>
                        </section>
                        <section class="manage-section">
                            <h3>创建新类型</h3>
                            <p class="manage-hint">设置类型名称和颜色，方便在日历中快速识别。</p>
                            <form id="manage-type-form" class="manage-type-form">
                                <label class="modal-label" for="manage-type-name">类型名称</label>
                                <input type="text" id="manage-type-name" placeholder="例如：学习、运动、亲子时间">
                                <label class="modal-label" for="manage-type-color">类型颜色</label>
                                <div class="manage-color-row">
                                    <input type="color" id="manage-type-color" value="#667eea">
                                    <input type="text" id="manage-type-color-preview" class="manage-color-preview" value="#667eea" placeholder="#667eea" maxlength="7">
                                </div>
                                <button type="submit" class="btn-primary manage-submit">+ 创建类型</button>
                            </form>
                        </section>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="js/event-manager.js"></script>
    <script src="js/plans-api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/calendar.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = getUser();
            if (user) {
                document.getElementById('user-display-name').textContent = user.username;
                
                if (user.is_admin) {
                    const adminSection = document.getElementById('admin-section');
                    if (adminSection) adminSection.style.display = 'block';
                } else {
                    // Hide Manage Tab for non-admins if required by "普通用户无权查看管理"
                    // If "管理" means the whole tab:
                    const manageBtn = document.getElementById('nav-manage');
                    if (manageBtn) manageBtn.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
